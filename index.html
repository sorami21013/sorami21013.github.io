<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>英語単語帳アプリ（Excel対応＋検索）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Excel(.xlsx)を読み込む／書き出すためのライブラリ（SheetJS） -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      background: #f4f4f7;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
    }

    .app {
      width: 100%;
      max-width: 800px;
      margin: 24px;
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
      padding: 24px 28px 28px;
    }

    h1 {
      font-size: 1.6rem;
      margin: 0 0 4px;
    }

    .subtitle {
      color: #666;
      font-size: 0.9rem;
      margin-bottom: 20px;
    }

    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 10px;
    }

    .form-row input[type="text"] {
      flex: 1 1 160px;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #d0d0dc;
      font-size: 0.95rem;
    }

    .form-row input[type="text"]:focus {
      outline: none;
      border-color: #4f46e5;
      box-shadow: 0 0 0 2px rgba(79,70,229,0.15);
    }

    .form-row input[type="file"] {
      flex: 1 1 200px;
      font-size: 0.85rem;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: transform 0.05s ease-out, box-shadow 0.05s ease-out, background 0.15s;
      white-space: nowrap;
    }

    .btn-primary {
      background: #4f46e5;
      color: #fff;
      box-shadow: 0 4px 12px rgba(79,70,229,0.25);
    }

    .btn-primary:hover {
      background: #4338ca;
      transform: translateY(-1px);
      box-shadow: 0 6px 14px rgba(79,70,229,0.32);
    }

    .btn-secondary {
      background: #eef1ff;
      color: #333;
    }

    .btn-secondary:hover {
      background: #e0e4ff;
      transform: translateY(-1px);
    }

    .btn-ghost {
      background: transparent;
      color: #777;
      border-radius: 999px;
    }

    .btn-ghost:hover {
      background: #f2f2f7;
      transform: translateY(-1px);
    }

    .section-title {
      font-size: 1rem;
      margin: 18px 0 8px;
      font-weight: 600;
    }

    .hint {
      font-size: 0.78rem;
      color: #888;
      margin-bottom: 4px;
    }

    .flashcard-container {
      margin-top: 8px;
      border-radius: 16px;
      padding: 20px;
      border: 1px solid #e2e2ee;
      background: linear-gradient(135deg, #fdfbff, #f3f4ff);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .card {
      border-radius: 14px;
      padding: 24px 20px;
      background: #ffffff;
      border: 1px solid #e0e0f0;
      min-height: 90px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      font-size: 1.3rem;
      font-weight: 500;
      cursor: pointer; /* クリックできることがわかるように */
      transition: transform 0.1s ease-out, box-shadow 0.1s ease-out;
    }

    .card:active {
      transform: scale(0.98);
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    }

    .card-side-label {
      font-size: 0.8rem;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .card-text-empty {
      color: #aaa;
      font-size: 0.95rem;
    }

    .card-controls {
      display: flex;
      gap: 8px;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 4px;
    }

    .card-meta {
      display: flex;
      justify-content: space-between;
      font-size: 0.8rem;
      color: #777;
      margin-top: 2px;
    }

    .word-list {
      margin-top: 12px;
      max-height: 220px;
      overflow: auto;
      border-radius: 12px;
      border: 1px solid #e4e4f0;
      background: #fafafe;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    th, td {
      padding: 6px 10px;
      border-bottom: 1px solid #ececf5;
    }

    th {
      background: #f3f4ff;
      position: sticky;
      top: 0;
      z-index: 1;
      text-align: left;
    }

    tr:last-child td {
      border-bottom: none;
    }

    .cell-en {
      font-weight: 500;
    }

    .cell-jp {
      color: #444;
    }

    .empty-list {
      font-size: 0.88rem;
      color: #888;
      padding: 10px;
      text-align: center;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 0.75rem;
      background: #eef1ff;
      color: #4f46e5;
      padding: 2px 8px;
      border-radius: 999px;
    }

    .top-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      gap: 8px;
    }

    .top-row-right {
      display: flex;
      gap: 6px;
      align-items: center;
      font-size: 0.8rem;
      color: #777;
    }

    .search-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
      flex-wrap: wrap;
    }

    .search-row input {
      flex: 1 1 160px;
    }

    .search-meta {
      font-size: 0.78rem;
      color: #777;
      white-space: nowrap;
    }

    .order-select {
      font-size: 0.78rem;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #d0d0dc;
      background: #fff;
    }

    @media (max-width: 600px) {
      .app {
        margin: 12px;
        padding: 18px 16px 20px;
      }
      h1 {
        font-size: 1.3rem;
      }
      .card {
        font-size: 1.15rem;
        padding: 18px 16px;
      }
      .search-row {
        flex-direction: column;
        align-items: stretch;
      }
      .search-meta {
        text-align: right;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="top-row">
      <div>
        <h1>英語単語帳アプリ（Excel対応＋検索）</h1>
        <div class="subtitle">Excel / 手入力から単語を追加できるフラッシュカード</div>
      </div>
      <div class="top-row-right">
        <span class="tag">保存先: ブラウザ（localStorage）</span>
      </div>
    </div>

    <!-- ① 手入力で追加 -->
    <div class="section-title">単語を追加（手入力）</div>
    <div class="form-row">
      <input id="englishInput" type="text" placeholder="English（例: empirical）" />
      <input id="japaneseInput" type="text" placeholder="日本語訳（例: 実証的）" />
      <button id="addButton" class="btn btn-primary" type="button">単語を追加</button>
    </div>

    <!-- ② フラッシュカード表示 -->
    <div class="section-title">フラッシュカード</div>
    <div class="flashcard-container">
      <div class="card-side-label" id="cardSideLabel">SIDE: English</div>
      <div class="card" id="flashcard">
        <span class="card-text-empty">まだ単語が登録されていません。</span>
      </div>
      <div class="card-controls">
        <button class="btn btn-secondary" id="prevButton" type="button">前へ</button>
        <button class="btn btn-secondary" id="nextButton" type="button">次へ</button>
        <button class="btn btn-secondary" id="randomButton" type="button">ランダム</button>
        <button class="btn btn-ghost" id="flipButton" type="button">表裏を反転</button>
      </div>
      <div class="card-meta">
        <span id="cardIndexLabel">0 / 0</span>
        <button class="btn btn-ghost" id="clearAllButton" type="button">全単語を削除</button>
      </div>
    </div>

    <!-- ③ 単語一覧＋検索＋並び替え -->
    <div class="section-title">登録されている単語一覧</div>
    <div class="search-row">
      <input id="searchInput" type="text" placeholder="単語を検索（英語 or 日本語の一部）" />
      <select id="orderSelect" class="order-select">
        <option value="added">追加順で表示</option>
        <option value="alpha">英語アルファベット順で表示</option>
      </select>
      <div class="search-meta" id="searchMeta">0 件中 0 件表示</div>
    </div>
    <div class="word-list" id="wordListContainer">
      <div class="empty-list">単語がまだありません。入力フォームやExcelから追加してください。</div>
    </div>

    <!-- ④ Excel から読み込み -->
    <div class="section-title">Excel から読み込む</div>
    <div class="hint">※ 1行目が <code>English</code> / <code>Japanese</code> のヘッダーになっている形式（あなたの単語リストと同じ）</div>
    <div class="form-row">
      <input id="excelInput" type="file" accept=".xlsx,.xls" />
      <button id="importButton" class="btn btn-secondary" type="button">Excelを読み込む</button>
    </div>

    <!-- ⑤ Excel に書き出す -->
    <div class="form-row">
      <button id="exportExcelButton" class="btn btn-secondary" type="button">Excelを書き出す（英語アルファベット順）</button>
    </div>
  </div>

  <script>
    // ----- データ管理 -----
    const STORAGE_KEY = "vocab_words_v1";

    /** 単語の配列: { en: string, jp: string } */
    let words = [];
    let currentIndex = 0;
    let showEnglishSide = true; // true: English, false: Japanese
    let searchQuery = "";       // 検索文字列
    let orderMode = "added";    // "added" | "alpha"

    const englishInput = document.getElementById("englishInput");
    const japaneseInput = document.getElementById("japaneseInput");
    const addButton = document.getElementById("addButton");

    const flashcard = document.getElementById("flashcard");
    const cardSideLabel = document.getElementById("cardSideLabel");
    const cardIndexLabel = document.getElementById("cardIndexLabel");
    const prevButton = document.getElementById("prevButton");
    const nextButton = document.getElementById("nextButton");
    const randomButton = document.getElementById("randomButton");
    const flipButton = document.getElementById("flipButton");
    const clearAllButton = document.getElementById("clearAllButton");

    const wordListContainer = document.getElementById("wordListContainer");
    const searchInput = document.getElementById("searchInput");
    const searchMeta = document.getElementById("searchMeta");
    const orderSelect = document.getElementById("orderSelect");

    const excelInput = document.getElementById("excelInput");
    const importButton = document.getElementById("importButton");
    const exportExcelButton = document.getElementById("exportExcelButton");

    // ローカルストレージから読み込み
    function loadWords() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) {
          const parsed = JSON.parse(raw);
          if (Array.isArray(parsed)) {
            words = parsed;
          }
        }
      } catch (e) {
        console.error("Failed to load words:", e);
      }
    }

    // ローカルストレージへ保存
    function saveWords() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(words));
    }

    // ----- UI更新 -----

    function updateFlashcard() {
      flashcard.innerHTML = "";

      if (words.length === 0) {
        const span = document.createElement("span");
        span.className = "card-text-empty";
        span.textContent = "まだ単語が登録されていません。入力フォームやExcelから追加してください。";
        flashcard.appendChild(span);
        cardIndexLabel.textContent = "0 / 0";
        return;
      }

      if (currentIndex < 0) currentIndex = 0;
      if (currentIndex >= words.length) currentIndex = words.length - 1;

      const word = words[currentIndex];
      const span = document.createElement("span");
      span.textContent = showEnglishSide ? word.en : word.jp;
      flashcard.appendChild(span);

      cardSideLabel.textContent = showEnglishSide ? "SIDE: English" : "SIDE: 日本語";
      cardIndexLabel.textContent = (currentIndex + 1) + " / " + words.length;
    }

    // 検索条件に合うかどうか
    function matchesSearch(word, query) {
      if (!query) return true;
      const q = query.toLowerCase();
      return (
        word.en.toLowerCase().includes(q) ||
        word.jp.toLowerCase().includes(q)
      );
    }

    function renderWordList() {
      wordListContainer.innerHTML = "";

      if (words.length === 0) {
        const div = document.createElement("div");
        div.className = "empty-list";
        div.textContent = "単語がまだありません。入力フォームやExcelから追加してください。";
        wordListContainer.appendChild(div);
        searchMeta.textContent = "0 件中 0 件表示";
        return;
      }

      // 元配列 + インデックスを持った配列を作る
      const indexed = words.map((word, index) => ({ word, index }));

      // 検索でフィルタ
      let displayItems = indexed.filter(item => matchesSearch(item.word, searchQuery));

      // 並び替えモードに応じてソート
      if (orderMode === "alpha") {
        displayItems = displayItems.slice().sort((a, b) =>
          a.word.en.localeCompare(b.word.en)
        );
      }
      const visibleCount = displayItems.length;

      if (visibleCount === 0) {
        const div = document.createElement("div");
        div.className = "empty-list";
        div.textContent = "検索条件に一致する単語がありません。";
        wordListContainer.appendChild(div);
        searchMeta.textContent = `${words.length} 件中 0 件表示`;
        return;
      }

      const table = document.createElement("table");
      const thead = document.createElement("thead");
      const headerRow = document.createElement("tr");
      ["English", "日本語訳", "操作"].forEach(text => {
        const th = document.createElement("th");
        th.textContent = text;
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      table.appendChild(thead);

      const tbody = document.createElement("tbody");

      displayItems.forEach(({ word, index }) => {
        const tr = document.createElement("tr");
        tr.style.cursor = "pointer";

        const tdEn = document.createElement("td");
        tdEn.className = "cell-en";
        tdEn.textContent = word.en;

        const tdJp = document.createElement("td");
        tdJp.className = "cell-jp";
        tdJp.textContent = word.jp;

        const tdAction = document.createElement("td");
        const delButton = document.createElement("button");
        delButton.textContent = "削除";
        delButton.className = "btn btn-ghost";
        delButton.style.fontSize = "0.75rem";
        delButton.addEventListener("click", (event) => {
          event.stopPropagation(); // 行クリック（カードジャンプ）を発火させない
          if (confirm(`「${word.en}」を削除しますか？`)) {
            words.splice(index, 1);
            if (currentIndex >= words.length) {
              currentIndex = words.length - 1;
            }
            saveWords();
            renderWordList();
            updateFlashcard();
          }
        });
        tdAction.appendChild(delButton);

        tr.appendChild(tdEn);
        tr.appendChild(tdJp);
        tr.appendChild(tdAction);

        // 行クリックでその単語のカードへジャンプ
        tr.addEventListener("click", () => {
          currentIndex = index;
          showEnglishSide = true; // 英語側から表示
          updateFlashcard();
        });

        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      wordListContainer.appendChild(table);

      searchMeta.textContent = `${words.length} 件中 ${visibleCount} 件表示`;
    }

    // ----- 単語追加（手入力） -----
    function addWord() {
      const en = englishInput.value.trim();
      const jp = japaneseInput.value.trim();

      if (!en || !jp) {
        alert("English と 日本語訳の両方を入力してください。");
        return;
      }

      const existingIndex = words.findIndex(w => w.en.toLowerCase() === en.toLowerCase());
      if (existingIndex !== -1) {
        const overwrite = confirm(`「${en}」はすでに登録されています。上書きしますか？`);
        if (overwrite) {
          words[existingIndex].jp = jp;
          currentIndex = existingIndex;
        } else {
          return;
        }
      } else {
        words.push({ en, jp });
        currentIndex = words.length - 1;
      }

      saveWords();
      renderWordList();
      updateFlashcard();

      englishInput.value = "";
      japaneseInput.value = "";
      englishInput.focus();
    }

    addButton.addEventListener("click", addWord);

    englishInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        if (!japaneseInput.value.trim()) {
          japaneseInput.focus();
        } else {
          addWord();
        }
      }
    });

    japaneseInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        addWord();
      }
    });

    // ----- 検索 -----
    searchInput.addEventListener("input", (e) => {
      searchQuery = e.target.value;
      renderWordList();
    });

    // ----- 並び替えモード -----
    orderSelect.addEventListener("change", (e) => {
      orderMode = e.target.value; // "added" or "alpha"
      renderWordList();
    });

    // ----- Excel から読み込み -----
    function importFromExcel() {
      const file = excelInput.files[0];
      if (!file) {
        alert("読み込む Excel ファイルを選択してください。");
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: "array" });
          const sheetName = workbook.SheetNames[0];
          const sheet = workbook.Sheets[sheetName];

          const json = XLSX.utils.sheet_to_json(sheet, { defval: "" });

          let importedCount = 0;
          json.forEach(row => {
            const enRaw = row.English ?? row.english ?? "";
            const jpRaw = row.Japanese ?? row.japanese ?? "";

            const en = String(enRaw).trim();
            const jp = String(jpRaw).trim();

            if (!en || !jp) return;

            const existingIndex = words.findIndex(
              w => w.en.toLowerCase() === en.toLowerCase()
            );
            if (existingIndex !== -1) {
              words[existingIndex].jp = jp;
            } else {
              // 追加順を保つため、ここではソートせず末尾に追加
              words.push({ en, jp });
            }
            importedCount++;
          });

          if (importedCount === 0) {
            alert("読み込めるデータが見つかりませんでした。\nヘッダー行が English / Japanese になっているか確認してください。");
            return;
          }

          currentIndex = 0;
          showEnglishSide = true;
          saveWords();
          renderWordList();
          updateFlashcard();

          alert(`Excel から ${importedCount} 件の単語を読み込みました。`);
        } catch (err) {
          console.error(err);
          alert("Excel の読み込み中にエラーが発生しました。ファイル形式を確認してください。");
        }
      };

      reader.readAsArrayBuffer(file);
    }

    importButton.addEventListener("click", importFromExcel);

    // ----- Excel に書き出し（常に英語アルファベット順） -----
    function exportToExcel() {
      if (words.length === 0) {
        alert("書き出す単語がありません。");
        return;
      }

      // words のコピーを英語アルファベット順にソート
      const sorted = words.slice().sort((a, b) =>
        a.en.localeCompare(b.en)
      );

      // ヘッダー行＋データ行の2列（English, Japanese）
      const data = [["English", "Japanese"]];
      sorted.forEach(word => {
        data.push([word.en, word.jp]);
      });

      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(data);
      XLSX.utils.book_append_sheet(wb, ws, "Vocabulary");

      XLSX.writeFile(wb, "vocabulary.xlsx");
    }

    exportExcelButton.addEventListener("click", exportToExcel);

    // ----- カード操作 -----
    prevButton.addEventListener("click", () => {
      if (words.length === 0) return;
      currentIndex = (currentIndex - 1 + words.length) % words.length;
      updateFlashcard();
    });

    nextButton.addEventListener("click", () => {
      if (words.length === 0) return;
      currentIndex = (currentIndex + 1) % words.length;
      updateFlashcard();
    });

    randomButton.addEventListener("click", () => {
      if (words.length === 0) return;
      const rand = Math.floor(Math.random() * words.length);
      currentIndex = rand;
      updateFlashcard();
    });

    flipButton.addEventListener("click", () => {
      showEnglishSide = !showEnglishSide;
      updateFlashcard();
    });

    // ★ 追加：カード本体をタップ／クリックで表裏反転
    flashcard.addEventListener("click", () => {
      if (words.length === 0) return;
      showEnglishSide = !showEnglishSide;
      updateFlashcard();
    });

    clearAllButton.addEventListener("click", () => {
      if (words.length === 0) return;
      if (confirm("全ての単語を削除しますか？（元に戻せません）")) {
        words = [];
        currentIndex = 0;
        saveWords();
        renderWordList();
        updateFlashcard();
      }
    });

    // 初期化
    loadWords();
    renderWordList();
    updateFlashcard();
  </script>
</body>
</html>
